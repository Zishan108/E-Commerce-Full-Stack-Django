{% extends 'store/base.html' %}

{% block title %}{{ product.name }} | Zishan Fashion{% endblock %}

{% block content %}
<div id="cart-alert" class="position-fixed top-0 end-0 m-3" style="z-index: 9999;"></div>

<div class="row">
    <div class="col-md-6">
        {% if product.image %}
        <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}">
        {% else %}
        <img src="https://via.placeholder.com/400x400?text=No+Image" class="img-fluid" alt="No image">
        {% endif %}
    </div>

    <div class="col-md-6">
        <h2>{{ product.name }}</h2>
        <p class="text-muted">
            Category: <a href="{% url 'store:category_products' product.category.slug %}">{{ product.category.name }}</a>
        </p>
        <h4 class="text-success">₹{{ product.price }}</h4>
        <p>{{ product.description|default:"No description available." }}</p>
        <p>Stock: {{ product.stock }}</p>

        {% if product.stock > 0 %}
            {% if user.is_authenticated %}
            <a href="#" class="btn btn-success add-to-cart-btn" data-product-id="{{ product.id }}">
                Add to Cart
            </a>
            {% else %}
            <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                Login to Add
            </a>
            {% endif %}
        {% else %}
            <button class="btn btn-secondary" disabled>Out of Stock</button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.add-to-cart-btn');
    const alertDiv = document.getElementById('cart-alert');

    buttons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const productId = this.dataset.productId;

            fetch(`/add-to-cart/${productId}/`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const alertEl = document.createElement('div');
                    alertEl.className = 'alert alert-success alert-dismissible fade show';
                    alertEl.innerHTML = `✅ ${data.message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                    alertDiv.appendChild(alertEl);

                    setTimeout(() => {
                        alertEl.classList.remove('show');
                        alertEl.remove();
                    }, 3000);
                } else {
                    alert(data.message);
                }
            });
        });
    });
});
</script>
{% endblock %}
