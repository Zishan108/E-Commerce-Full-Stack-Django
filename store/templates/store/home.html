{% extends 'store/base.html' %}

{% block title %}Home | Zishan Fashion{% endblock %}

{% block content %}
<h2 class="mb-4">Categories</h2>
<div class="row mb-5">
    {% for cat in categories %}
    <div class="col-md-3 mb-3">
        <a href="/category/{{ cat.slug }}/" class="text-decoration-none">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ cat.name }}</h5>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>

<h2 class="mb-4">Latest Products</h2>

<div id="cart-alert" class="position-fixed top-0 end-0 m-3" style="z-index: 9999;"></div>

<div class="row">
    {% for product in products %}
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text">₹{{ product.price }}</p>

                {% if product.stock > 0 %}
                    {% if user.is_authenticated %}
                    <a href="#" class="btn btn-success add-to-cart-btn" data-product-id="{{ product.id }}">
                        Add to Cart
                    </a>
                    {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                        Login to Add
                    </a>
                    {% endif %}
                {% else %}
                    <button class="btn btn-secondary" disabled>Out of Stock</button>
                {% endif %}

                <a href="/product/{{ product.slug }}/" class="btn btn-primary mt-2">View</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.add-to-cart-btn');
    const alertDiv = document.getElementById('cart-alert');

    buttons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const productId = this.dataset.productId;

            fetch(`/add-to-cart/${productId}/`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const alertEl = document.createElement('div');
                    alertEl.className = 'alert alert-success alert-dismissible fade show';
                    alertEl.innerHTML = `✅ ${data.message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                    alertDiv.appendChild(alertEl);

                    setTimeout(() => {
                        alertEl.classList.remove('show');
                        alertEl.remove();
                    }, 3000);
                } else {
                    alert(data.message);
                }
            });
        });
    });
});
</script>
{% endblock %}
